syntax = "proto3";

package gameagent;

option go_package = "github.com/hellof20/joey-proto/proto;proto";

// GameAgentService 游戏代理服务
service GameAgentService {
  // ClientStream 客户端双向流连接
  rpc ClientStream(stream ClientMessage) returns (stream ServerMessage);
}

message ClientMessage {
  oneof message {
    RegisterRequest register = 1;
    ScreenshotResponse screenshot_response = 2;
    ActionResponse action_response = 3;
    HeartbeatRequest heartbeat = 4;
    VideoRecordingResponse video_recording_response = 5;
    VideoSegmentUpload video_segment_upload = 6;
    VideoRecordingComplete video_recording_complete = 7;
  }
}

// ServerMessage 服务端发送的消息
message ServerMessage {
  oneof message {
    ScreenshotRequest screenshot_request = 1;
    ActionRequest action_request = 2;
    HeartbeatResponse heartbeat_response = 3;
    CloseAppRequest close_app_request = 4;
    ShutdownEvent shutdown_event = 5;
    CancelActionRequest cancel_action_request = 6;
  }
}

// VideoRecordingResponse 录屏响应
message VideoRecordingResponse {
  string task_id = 1;
  bytes video_data = 2;
  bool success = 3;
  string error = 4;
  string execution_id = 5;
}

// VideoSegmentUpload 单个视频片段上传
message VideoSegmentUpload {
  string task_id = 1;
  string execution_id = 2;
  int32 segment_index = 3;  // 片段索引，从1开始
  bytes segment_data = 4;   // 片段数据
}

// VideoRecordingComplete 视频录制完成通知
message VideoRecordingComplete {
  string task_id = 1;
  string execution_id = 2;
  int32 total_segments = 3;  // 总共上传的片段数
}

// CancelActionRequest 取消正在执行的动作
message CancelActionRequest {
  string task_id = 1;
  int32 step = 2;
  string reason = 3;
}

// ShutdownEvent tells the client that the server is shutting down.
message ShutdownEvent {}

// CloseAppRequest is a request from the server to the client to close an application.
message CloseAppRequest {
  string app_name = 1; // The name of the app to close (e.g., package name for Android, executable name for PC)
  string task_id = 2;
  string execution_id = 3;
}

// RegisterRequest 客户端注册请求
message RegisterRequest {
  string client_id = 1;
  string client_name = 2;
  string device_type = 3;
  int32 width = 4;
  int32 height = 5;
  string api_key = 6;
  string os = 7;
  string hostname = 8;
  string arch = 9;
  string version = 10;
  bool headless = 11;
}

// ScreenshotRequest 截图请求
message ScreenshotRequest {
  string task_id = 1;
  int32 step = 2;
  string execution_id = 3;
}

// ScreenshotResponse 截图响应
message ScreenshotResponse {
  string task_id = 1;
  int32 step = 2;
  string screenshot = 3;  // Deprecated: use screenshot_data instead
  bool success = 4;
  string error = 5;
  DeviceInfo device_info = 6;
  bytes screenshot_data = 7;  // Binary screenshot data
}

// ActionRequest 动作执行请求
message ActionRequest {
  string task_id = 1;
  int32 step = 2;
  Action action = 3;
  string execution_id = 4;
}

// ActionResponse 动作执行响应
message ActionResponse {
  string task_id = 1;
  int32 step = 2;
  bool success = 3;
  string error = 4;
  string output = 5;  // 添加输出字段，用于返回工具执行结果（如 list_tabs 的 JSON）
  
  // 动作执行后的截图 (Base64 编码或 bytes)
  bytes screenshot = 6;
    
  // 截图相关的元数据 (可选)
  DeviceInfo device_info = 7;
}

// HeartbeatRequest 心跳请求
message HeartbeatRequest {
  string client_id = 1;
  int64 timestamp = 2;
}

// HeartbeatResponse 心跳响应
message HeartbeatResponse {
  int64 timestamp = 1;
}

// DeviceInfo 设备信息
message DeviceInfo {
  int32 width = 1;
  int32 height = 2;
  string client_id = 3;
  string client_name = 4;
  string device_type = 5;
  bool headless = 6;
}

// Coordinates - 屏幕坐标
message Coordinates {
  int32 x = 1;
  int32 y = 2;
}

// Action 执行动作 - 使用强类型参数
message Action {
  // 执行动作后的等待时间 (毫秒)
  // 如果设置，将覆盖客户端的默认配置
  int32 wait_time_ms = 26;
    
  // 是否需要在执行后返回截图
  bool require_screenshot = 27;

  oneof params {
    ClickParams click = 2;
    TypeTextParams type_text = 3;
    ScrollParams scroll = 4;
    ScrollAtParams scroll_at = 5;
    NavigateParams navigate = 6;
    WaitParams wait = 7;
    PressKeyParams press_key = 8;
    SearchParams search = 9;
    ClearTextParams clear_text = 10;
    StartAppParams start_app = 11;
    StopAppParams stop_app = 12;
    NewTabParams new_tab = 13;
    CloseTabParams close_tab = 14;
    SwitchTabParams switch_tab = 15;
    ListTabsParams list_tabs = 16;
    RightClickParams right_click = 17;
    HoverParams hover = 18;
    DoubleClickParams double_click = 19;
    TakeScreenshotParams take_screenshot = 20;
    CompleteParams complete = 21;
    FailedParams failed = 22;
    StartRecordingParams start_recording = 23;
    StopRecordingParams stop_recording = 24;
    SwipeParams swipe = 25;
  }
}

// ClickParams - 点击/触摸屏幕
message ClickParams {
  Coordinates coordinates = 1;
}

// TypeTextParams - 输入文本
message TypeTextParams {
  Coordinates coordinates = 1;
  string content = 2;  // 输入内容
}

// ScrollParams - 滚动屏幕
message ScrollParams {
  string direction = 1;  // "up", "down", "left", "right"
  string scroll_type = 2;  // "once", "untilBottom", "untilTop", "untilLeft", "untilRight"
  int32 distance_px = 3;  // 滚动距离（像素）
  Coordinates coordinates = 4;  // 滚动起点（可选）
}

// ScrollAtParams - 在特定位置滚动
message ScrollAtParams {
  Coordinates coordinates = 1;
  string direction = 2;  // "up" or "down"
  int32 distance_px = 3;  // 滚动距离（像素）
}

// NavigateParams - 导航（浏览器）
message NavigateParams {
  string url = 1;
}

// WaitParams - 等待指定时间
message WaitParams {
  int32 duration_ms = 1;  // 等待毫秒数
}

// PressKeyParams - 按键
message PressKeyParams {
  string key = 1;  // 按键名称
}

// SearchParams - 搜索
message SearchParams {
  Coordinates coordinates = 1;
  string content = 2;  // 搜索内容
}

// ClearTextParams - 清除文本
message ClearTextParams {
  Coordinates coordinates = 1;
}

// StartAppParams - 启动应用
message StartAppParams {
  string app_name = 1;  // 应用名称/包名/可执行文件名
}

// StopAppParams - 停止应用
message StopAppParams {
  string app_name = 1;
}

// NewTabParams - 新建标签页
message NewTabParams {
  string url = 1;  // 可选的初始URL
}

// CloseTabParams - 关闭标签页
message CloseTabParams {
  string tab_id = 1;  // 标签页ID
}

// SwitchTabParams - 切换标签页
message SwitchTabParams {
  string tab_id = 1;  // 标签页ID
}

// ListTabsParams - 列出标签页
message ListTabsParams {
  // 无参数
}

// RightClickParams - 右键点击
message RightClickParams {
  Coordinates coordinates = 1;
  string locate = 2;  // 元素描述（可选）
}

// HoverParams - 鼠标悬停
message HoverParams {
  Coordinates coordinates = 1;
  string locate = 2;  // 元素描述（可选）
}

// DoubleClickParams - 双击
message DoubleClickParams {
  Coordinates coordinates = 1;
  string locate = 2;  // 元素描述（可选）
}

// TakeScreenshotParams - 截图
message TakeScreenshotParams {
  // 无参数
}

// CompleteParams - 任务完成
message CompleteParams {
  string reason = 1;  // 完成原因
}

// FailedParams - 任务失败
message FailedParams {
  string reason = 1;  // 失败原因
}

// StartRecordingParams - 开始录屏
message StartRecordingParams {
  // 无参数
}

// StopRecordingParams - 停止录屏
message StopRecordingParams {
  // 无参数
}

// SwipeParams - 滑动（精确）
message SwipeParams {
  Coordinates start = 1;
  Coordinates end = 2;
  int32 duration_ms = 3;
}
